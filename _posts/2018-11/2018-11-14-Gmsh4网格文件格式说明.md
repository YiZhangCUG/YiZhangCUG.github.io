---
layout: post
title: "Gmsh4网格文件格式说明"
author: Yi Zhang
date: 2018-11-14 17:47:28 -0800
category:  program
tags: [gmsh,visualization]
header-img: "img/light.jpeg"
---

* content
{:toc}



[Gmsh](http://gmsh.info)是一个跨平台三维有限元网络生成与可视化软件。我们可以使用它进行三维有限元网络的前（建模）后（可视化）处理。期间需要使用到的文件即为其网格文件(后缀为.msh)，建模中使用的文件格式为.geo文件，其具体格式请参见Gmsh说明文档。Gmsh网格文件主要包含对三维网络中顶点（Nodes）、几何元素（Elements）、顶点数据（NodeData）、和元素数据（ElementData）的描述。同时还可以包含对几何元素或物理元素组的定义。Gmsh定义的网络文件格式分为相对较为简单的2.0版本和Gmsh4开始使用的4.0版本。本文主要包含对Gmsh说明文档中两个版本网络文件格式部分的翻译说明，以及简单的示例文件。本文所设计的网络文件均为ASCII码文件，相应的二进制文件格式请参见Gmsh说明文档。

## Gmsh2网格文件格式

### 文件预览

我们首先给出一个Gmsh2版本的四方体网格文件（[cube.msh](/assets/2018-11/cube-msh.msh)），使用Gmsh查看如下所示：

![cube mesh display](/assets/2018-11/cube-mesh-display.png)

使用文本编辑器打开cube.msh，内容如下所示：

```text
$MeshFormat
2.2 0 8
$EndMeshFormat
$Nodes
8
1 0.0 0.0 0.0
2 1.0 0.0 0.0
3 1.0 1.0 0.0
4 0.0 1.0 0.0
5 0.0 0.0 1.0
6 1.0 0.0 1.0
7 1.0 1.0 1.0
8 0.0 1.0 1.0
$EndNodes
$Elements
1
1 5 1 10 1 2 3 4 5 6 7 8
$EndElements
$NodeData
1
"node data"
1
0.0
3
0
1
8
1 0.1
2 0.1
3 0.1
4 0.1
5 1.0
6 1.0
7 1.0
8 1.0
$EndNodeData
$ElementData
1
"element data"
1
0.0
3
0
1
1
1 2
$EndElementData
```

### 格式说明

+ `$MeshFormat`与`$EndMeshFormat`关键字其间定义了网络文件的版本（2.2）与必要信息，包括文件类型（对于ASCII码文件，其值为0）和浮点类型长度值（一般为8）。

+ `$Nodes`与`$EndNodes`关键字内包含网络文件的顶点信息。第一行为顶点的总个数。其后每一行为顶点的序号和直角坐标，以空格分割。顶点的序号是识别顶点的唯一指标，可以从0或1开始，也可以不连续（但可能会增加电脑内存的开销）。对于两个坐标相同但序号不同的顶点，Gmsh将视为两个独立的顶点。

+ `$Elements`与`$EndElements`关键字内包含几何元素信息。第一行为元素的总个数。其后每一行为对单个元素的信息描述，格式为`<元素序号> <元素类型> <标签数> <标签1> ... <顶点序号列表>`。

+ `<元素序号>`为元素的识别标示，可以从0或1开始，也可以不连续（但可能会增加电脑内存的开销）。
+ `<元素类型>`为Gmsh预定义用于识别元素类型的一个整数，例如立方体对应代码为5（其他类型元素的代码请参见Gmsh说明文档）。
+ `<标签数>`标示其后跟随的元素标签的个数。Gmsh预定义元素的第一个标签为其所属的物理组，第二个标签为其所属的几何组。示例中四方体有一个标签，标签代码为10。对于更复杂的网格文件我们可以对元素归类到不同物理或几何组，Gmsh将使用不同的颜色显示不同组别，方便我们查看网络文件。
+ `<顶点序号列表>`为组成元素的顶点集，对应于`$Nodes`标签中对应的顶点序号。注意元素的顶点序列排列顺序应符合Gmsh预定义的顺序。

+ `$NodeData`与`$EndNodeData`(可选的)关键字内包含对顶点数据集的描述。从上至下依次为字符串标签的数量与字符串标签，Gmsh默认使用第一个字符串标签为数据集的名称；其下为浮点标签的个数与浮点标签，表示该数据集对应的时间；然后为整形标签个数与整形标签，分别为数据集的时间序列号（从0开始）、数据集场的分量个数（等于1、3或者9）以及数据点个数。头信息后，每一行包含`<顶点序号> <数据值>`。

![cube node data](/assets/2018-11/cube-node-data.png)

+ `$ELementData`与`$EndELementData`（可选的）关键字内包含对元素数据集的描述。其头信息格式与顶点数据相同，只是其后数据列中的序号为元素的序号。

![cube ele data](/assets/2018-11/cube-ele-data.png)

## Gmsh4网格文件格式

### 文件预览

我们还是先给出一个Gmsh4版本的四方体网格文件（[cube-gmsh4.msh](/assets/2018-11/cube-gmsh4-msh.msh)），使用文本编辑器打开cube-gmsh4.msh，内容如下所示：

```text
$MeshFormat
4.0 0 8
$EndMeshFormat
$Entities
8 12 6 1
1 0 0 0 0 0 0 0
2 1 0 0 1 0 0 0
3 1 1 0 1 1 0 0
4 0 1 1 0 1 1 0
5 0 0 1 0 0 1 0
6 1 0 1 1 0 1 0
7 1 1 1 1 1 1 0
8 0 1 1 0 1 1 0
1 0 0 0 1 0 0 0 2 1 -2
2 1 0 0 1 1 0 0 2 2 -3
3 0 1 0 1 1 0 0 2 3 -4
4 0 0 0 0 1 0 0 2 4 -1
5 0 0 1 1 0 1 0 2 5 -6
6 1 0 1 1 1 1 0 2 6 -7
7 0 1 1 1 1 1 0 2 7 -8
8 0 0 1 0 1 1 0 2 8 -5
9 0 0 0 0 0 1 0 2 1 -5
10 1 0 0 1 0 1 0 2 2 -6
11 1 1 0 1 1 1 0 2 3 -7
12 0 1 0 0 1 1 0 2 4 -8
1 0 0 0 1 1 0 0 4 -1 -2 -3 -4
2 0 0 1 1 1 1 0 4 5 6 7 8
3 0 0 0 1 0 1 0 4 -9 1 10 -5
4 1 0 0 1 1 1 0 4 -10 2 11 -6
5 0 1 0 1 1 1 0 4 12 -7 -11 3
6 0 0 0 0 1 1 0 4 9 -8 -12 4
1 0 0 0 1 1 1 0 6 1 2 3 4 5 6
$EndEntities
$Nodes
1 8
1 3 0 8
1 0.0 0.0 0.0
2 1.0 0.0 0.0
3 1.0 1.0 0.0
4 0.0 1.0 0.0
5 0.0 0.0 1.0
6 1.0 0.0 1.0
7 1.0 1.0 1.0
8 0.0 1.0 1.0
$EndNodes
$Elements
1 1
1 3 5 1
1 1 2 3 4 5 6 7 8
$EndElements
$NodeData
1
"node data"
1
0.0
3
0
1
8
1 0.1
2 0.1
3 0.1
4 0.1
5 1.0
6 1.0
7 1.0
8 1.0
$EndNodeData
$ElementData
1
"element data"
1
0.0
3
0
1
1
1 2
$EndElementData
```

对应Gmsh2的文件格式，可以发现主要存在以下几点变化：
+ 网络文件版本号由2.2变为4.0；
+ 增加了`$Entities`关键字；
+ 更改了`$Nodes`和`$Elements`内格式。

下面我们就后两点变化进行说明。

### 格式说明

+ Gmsh4在网络文件中增加了`$Entities`与`$EndEntities`关键字（不可选）用于说明网络文件中的实体范围（超出这个范围的输出将不被承认）。实体的空间维度由低向高产生依赖，所以对于一个三维实体范围我们必须定义实体点与面的范围定义。下面就其格式做具体说明：
+ 第一行为实体点、线、面和体的个数，对于一个四面体其值分别为8、12、6和1；
+ 实体点的描述，其格式为`<序号> <盒子左下底角坐标> <盒子右上顶角坐标> <物理标签个数> <物理标签> ...`。这个我们举出了盒子的概念，指的是能够包含所描述实体的一个四方体的范围。对于一个点而言，这个盒子的最小范围即为其坐标位置本身；
+ 实体线的描述，其格式为`<序号> <盒子左下底角坐标> <盒子右上顶角坐标> <物理标签个数> <物理标签> ... <包含的实体点个数> <实体点序号列表>`。相对于实体点，线描述所增加的内容对线构成的描述。即一条直线由其两个顶点的序号所描述，注意正的序号为起点，负的序号为终点；
+ 实体面的描述，其格式为`<序号> <盒子左下底角坐标> <盒子右上顶角坐标> <物理标签个数> <物理标签> ... <包含的实体线个数> <实体线序号列表>`。注意实体面包含的线序号需要首尾相接，Gmsh默认按照逆时针方向计算面的外法线方向。负的序号标示反向的线；
+ 实体的描述，其格式为`<序号> <盒子左下底角坐标> <盒子右上顶角坐标> <物理标签个数> <物理标签> ... <包含的实体面个数> <实体面序号列表>`。注意面的外法线方向朝向实体外部。
+ Gmsh4在`$Nodes`中增加了分块的概念，其具体格式为：
+ 第一行为块的个数与总的顶点个数，以下为每个块的内容；
+ 在每个块中，第一行为块的序号、块所属的空间维度、参数化值（一般为0）和当前块的顶点数，其后为顶点的序号和空间坐标位置。
+ 相应的，`$Elements`中也增加了分块的概念，其具体格式为：
+ 第一行为块的个数与总的元素个数，以下为每个块的内容；
+ 在每个块中，第一行为块的序号、块所属的空间维度、块的元素类型和当前块的元素数，其后为元素的序号和组成元素的顶点序号。可以注意到，对于每一个块，其包含的元素类型应该是一致的。

